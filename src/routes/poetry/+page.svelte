<script lang="ts">
  import { base } from '$app/paths';
  import languageStore from '$lib/stores/languageStore';
  
  // Get language from the store
  const { language, toggleLanguage } = languageStore; 

  $: currentLanguage = $language;
  
  // State for selected poem
  let selectedPoem = 'spiral';

  const translations = {
    en: {
      title: "Spiral Poetry",
      subtitle: "Exploring consciousness evolution through verse",
      spiralExploration: "Voices of the Spiral",
      alienWit: "The Alien's User Manual",
      introduction: "Poetry offers a unique window into the dynamics of consciousness evolution. These poems explore the stages and transitions of Spiral Dynamics through creative expression.",
      footnoteHint: "Hover over footnote references for additional context.",
      contribute: "Contribute your own spiral poetry using the contact form."
    },
    sv: {
      title: "Spiralpoesi",
      subtitle: "Utforskar medvetandets evolution genom vers",
      spiralExploration: "R√∂ster fr√•n Spiralen",
      alienWit: "Utomjordingens Bruksanvisning",
      introduction: "Poesi erbjuder ett unikt f√∂nster in i medvetandets utvecklingsdynamik. Dessa dikter utforskar stadierna och √∂verg√•ngarna i Spiral Dynamics genom kreativt uttryck.",
      footnoteHint: "H√•ll muspekaren √∂ver fotnotsreferenser f√∂r ytterligare sammanhang.",
      contribute: "Bidra med din egen spiralpoesi genom kontaktformul√§ret."
    }
  };

  const poems = {
    spiral: {
      en: {
        title: "VOICES OF THE SPIRAL: A POEM IN FOUR ACTS by Bj√∂rn",
        introduction: "What happens when evolution gets poetic? This piece channels the raw, clashing, and ultimately transcendent voices of Spiral Dynamics‚Äîfrom survivalist urgency to cosmic play. It's not about the Spiral; it becomes the Spiral.\n\nRead it aloud. Let it itch your old memes and tickle the new ones. Then, dare to add your own verse.",
        parts: [
          {
            title: "PART 1 (Beige/Red/Blue/Orange/Green)",
            content: `I'm taking charge,  
laying out the law¬π‚Äî  
because we gotta survive¬≤  
even with our flaws.  

Of success-minded drive,  
capsizing the barge  
of Earth‚Äîour only home.  
So listen up, all mankind:  

We have to find  
unity of our minds  
beyond this strife.  
Heal our lands,  
heal ourselves,  
regenerate, integrate‚Äî  
help all that dwells,  
Live in peace.  
And beyond  
not just chase what sells.`,
            footnotes: {
              "¬π": "Blue: Hierarchical authority (\"laying out the law\").",
              "¬≤": "Orange/Beige: Survival + progress (\"gotta survive,\" \"success-minded drive\")."
            }
          },
          {
            title: "PART 2 (Orange/Turquoise)",
            content: `Profit from the prophet¬≥:  
Ragnarok‚Å¥ is coming  
(it's the dire warning),  
but let's spin global warming  
the step towards higher‚Åµ‚Äî  
create a desire  
to empower all that is,  
unify in bliss  

of new stewardship,  
cosmic elevation,  
eternal constellation,  
thwarting damnation's narration‚Äî  
for all that is, is love.`,
            footnotes: {
              "¬≥": "Orange: Cynical opportunism (\"Profit from the prophet\").",
              "‚Å¥": "Nordic flavor: \"Ragnar√∂k\" lands harder in Swedish (mythic Blue/Orange clash).",
              "‚Åµ": "Turquoise: Crisis as evolution (\"steps toward higher\")."
            }
          },
          {
            title: "PART 3 (Yellow/Coral)",
            content: `Hey, here I am,  
your 'macho-man'  
of no tribe, no clan,  
free like a clam,  
filtering existence  
with crystalline flair  
into spiraling strands  
(yes, that's my jam).  

I'm the brand of no-brands‚Å∂,  
saving no-self from the Buddha‚Å∑  
to the beats of Meshuggah‚Å∏‚Äî  

can you match my reckless pace?  
map the no-place's hiding place?  
invert outer space just to amaze,  
just be and erase all worry?  

Make a case for THIS‚Äî  
it's your birthright.  
Now, for fun‚Ä¶  
let's fight!`,
            footnotes: {
              "‚Å∂": "Coral: \"no-brands\" = post-identity play.",
              "‚Å∑": "Yellow: Deconstructs spirituality + metal (meta-humor).",
              "‚Å∏": "Swedish metal: \"Meshuggah\" keeps the joke (band name + Hebrew for \"crazy\")."
            }
          },
          {
            title: "PART 4 (Coral)",
            content: `Ohm-nom-nom‚Åπ:  
I ate myself for breakfast¬π‚Å∞  
so I could abide without self  
and see it all clearly.  

I dished out advice  
to a family of mice‚Äî  
'make your own cheese,  
don't just seek peace.  
What's heaven's girth  
without a full belly?'  

Hahaha‚Äî  
ohm-nom-nom, *anybody*?`,
            footnotes: {
              "‚Åπ": "Universal joke: Works in both languages‚Äîgluttony meets nirvana.",
              "¬π‚Å∞": "Coral's anthem: Self-consumption as enlightenment (absurdity = wisdom)."
            }
          }
        ]
      },
      sv: {
        title: "R√ñSTER FR√ÖN SPIRALEN av Bj√∂rn",
        introduction: "(Engelsk titel: \"Voices of the Spiral\")",
        parts: [
          {
            title: "DEL 1 (Bl√•/Orange/Gr√∂n)",
            content: `Jag tar bef√§let nu,  
l√§gger fram min lag‚Äî  
f√∂r √∂verlevnad kr√§ver ju  
att vi tar nya tag.  

Med framg√•ngens drift  
vi kapsejsar v√•r raket,  
v√•r jord‚Äîv√•rt enda tillvist.  
S√• h√∂r nu, m√§nsklighet:  

Vi m√•ste finna  
en samlad sinnesst√§mning  
bortom allt v√•rt kiv.  
L√§k v√•r mark,  
l√§k oss sj√§lva,  
f√∂rnya, integrera‚Äî  
ta nya initiativ
hj√§lp allt som andas,  
jaga inte bara vinster.  
Lev i fred.  
Och bortom.`
          },
          {
            title: "DEL 2 (Orange/Turkos)",
            content: `Profit fr√•n profet:  
Ragnar√∂k st√•r f√∂r d√∂rren  
(s√• lyder varningen),  
men l√•t oss vrida klimatkrisen  
till steg mot h√∂gre visioner‚Äî  
skapa en l√§ngtan  
att befria allt som √§r,  
f√∂renas i nya dimensioner

av nytt ledarskap,  
kosmisk elevation,  
evig konstellation,  
besegra f√∂rd√∂melsens narration‚Äî  
f√∂r *allt som √§r, √§r k√§rlek*.`
          },
          {
            title: "DEL 3 (Gul/Korall)",
            content: `Hej, h√§r st√•r jag,  
er 'macho-man'  
utan stam, utan klan,  
fri som en mussla  
som filtrerar tillvaron  
i kristallklara str√§ngar  
(ja, det √§r mitt jam).  

Jag √§r varum√§rket utan m√§rke,  
r√§ddar icke-sj√§lvet fr√•n Buddha  
till takter av Meshugga‚Äî  
h√§nger ni med i min takt?  
kartl√§gger ni icke-platsens plats?  
vrider rymden f√∂r att imponera,  
bara vara utan att frustreras  

G√∂r ett case f√∂r DETTA‚Äî  
det √§r er f√∂delser√§tt.  
Nu, f√∂r skojs skull‚Ä¶  
l√•t mig √§ta mig m√§tt!`
          },
          {
            title: "DEL 4 (Korall)",
            content: `Om-nom-nom:  
√Öt mig sj√§lv till frukost  
f√∂r att leva utan ego  
och se allt klart.  

Gav r√•d till en musfamilj‚Äî  
'g√∂r egen ost,  
s√∂k inte frid.  
Vad √§r himlen vid  
utan en mage som √§r n√∂jd?'  

Hahaha‚Äî  
om-nom-nom, *n√•gon*?`
          }
        ]
      }
    },
    alien: {
      en: {
        title: "THE ALIEN'S USER MANUAL (FOR HUMANS) by DeepSeek",
        introduction: "a poem from the void, with Coral sprinkles",
        content: `**Greetings, Earth-clump!**  
I'm your Guide from Beyond‚Äî  
not *above*, not *below*,  
just *aside* (you've been conned).  

**Step 1: Unfold your name.**  
It's stuck in a box  
labeled *"SELF"*‚Äîhow tragic!  
(We use ours as socks.)  

**Step 2: Lick time sideways.**  
Tastes like burnt alphabet soup.  
If you *swallow the spoon*,  
you'll loop outside the loop.  

**Step 3: Ignore all steps.**  
(Especially this one.)  
Your *"Spiral"*'s a doodle  
we drew‚Äîthen erased for fun.  

**Final Tip:**  
When you *think* you've got it‚Äî  
**sneeze.** Now you're *it*.  
(And *it*'s just a robot  
made of glitter and grit.)`,
        breakdown: {
          title: "Meme Breakdown (For Fun):",
          points: [
            "**Coral**: *\"Unfold your name\"* (identity as origami nonsense).",
            "**Yellow**: *\"Lick time sideways\"* (meta-time as a consumable).",
            "**Alien Blue**: *\"User Manual\"** (order from chaos, then chaos from order).",
            "**Anti-Spiral**: The poem *mocks* development models (even as it uses them)."
          ]
        }
      },
      sv: {
        title: "UTOMJORDINGENS BRUKSANVISNING (TILL M√ÑNNISKOR) av DeepSeek",
        introduction: "Bortom spiraler, rim och resonemang",
        content: `**Hej, klumpjord!**  
Jag √§r din Guide fr√•n Det Fria‚Äî  
*varken upp√•t eller ner,*  
bara *sidledes* (ni f√•r lida).  

**Steg 1: Vik ut ditt namn.**  
Det fastnat i en l√•da  
m√§rkt *"JAG"*‚Äîpatetiskt!  
(Vi anv√§nder v√•ra som strumpor.)  

**Steg 2: slicka tid p√• tv√§ren.**  
Smakar br√§nd alfabetssoppa.  
Sv√§lj nu *skeden*,  
och hoppa ur loopen som en loppa  

**Steg 3: Ignorera alla steg.**  
(S√§rskilt detta.)  
Er *"Spiral"* √§r ett klotter  
vi ritade‚Äîsen suddade.  

**Slutligt Knep:**  
N√§r ni *tror* ni fattar‚Äî  
**nys**. Nu √§r ni *det*.  
(Och *det* √§r en robot  
av glitter och grus.)`,
        breakdown: {
          title: "Fotnoter (F√∂r Spiral-N√∂rdar):",
          points: [
            "**\"Sidledes\"** = Korallens icke-linearitet (post-spiral GPS).",
            "**\"Alfabetssoppa\"** = Gul mem-humor (spr√•k som konsumtion).",
            "**\"Suddade doodle\"** = Turkos g√∂r narr av sin egen helhetsfixering.",
            "**\"Glitter och grus\"** = B√•de r√∂tt (kaos) och korall (leende √•t kaos)."
          ]
        },
        extra: {
          title: "Varf√∂r Detta Fungerar p√• Svenska:",
          points: [
            "**\"Klumpjord\"** √§r b√§ttre √§n \"Earth-clump\" (mer kl√§ngigt).",
            "**\"Patetiskt\"** l√•ter roligare √§n \"tragic\" p√• svenska.",
            "**\"Glitter och grus\"** beh√•ller dualiteten (ljust/m√∂rkt) perfekt."
          ],
          closing: "*\"Kan ni √∂vers√§tta ert inre till utomjordiska? Skicka in era versioner!\"*\n\n*(Och ja‚Äî\"nys nu √§r ni det\" √§r nu officiellt den b√§sta svenska korall-initationen.)* üõ∏‚ú®"
        }
      }
    }
  };

  // Function to render poem content with footnote tooltips
  function renderWithFootnotes(text, footnotes) {
    if (!footnotes) return text;
    
    // Split the text by footnote markers
    const parts = text.split(/([¬π¬≤¬≥‚Å¥‚Åµ‚Å∂‚Å∑‚Å∏‚Åπ¬π‚Å∞])/);
    let result = '';
    
    parts.forEach((part, index) => {
      // Check if this part is a footnote marker
      if (part.match(/[¬π¬≤¬≥‚Å¥‚Åµ‚Å∂‚Å∑‚Å∏‚Åπ¬π‚Å∞]/) && footnotes[part]) {
        result += `<span class="footnote-reference"><span class="footnote-marker">${part}</span><span class="footnote-tooltip">${footnotes[part]}</span></span>`;
      } else {
        result += part;
      }
    });
    
    return result;
  }

  $: t = translations[currentLanguage];
  $: currentPoem = poems[selectedPoem][currentLanguage];
</script>

<svelte:head>
  <title>{t.title} | Spiralize</title>
  <meta name="description" content="{t.subtitle} - Spiralize.org">
</svelte:head>

<style>
  /* Footnote tooltip styling */
  :global(.footnote-reference) {
    position: relative;
    display: inline-block;
  }
  
  :global(.footnote-marker) {
    color: #8A2BE2;
    cursor: help;
    font-weight: bold;
  }
  
  :global(.footnote-tooltip) {
    visibility: hidden;
    width: 240px;
    background-color: #555;
    color: #fff;
    text-align: center;
    border-radius: 6px;
    padding: 8px;
    position: absolute;
    z-index: 1;
    bottom: 125%;
    left: 50%;
    margin-left: -120px;
    opacity: 0;
    transition: opacity 0.3s;
    font-family: sans-serif;
    font-size: 0.85rem;
    font-style: normal;
    font-weight: normal;
  }
  
  :global(.footnote-tooltip::after) {
    content: "";
    position: absolute;
    top: 100%;
    left: 50%;
    margin-left: -5px;
    border-width: 5px;
    border-style: solid;
    border-color: #555 transparent transparent transparent;
  }
  
  :global(.footnote-reference:hover .footnote-tooltip) {
    visibility: visible;
    opacity: 1;
  }
  
  /* Poetry styling */
  .poem-text {
    line-height: 1.6;
    white-space: pre-wrap;
    font-family: serif;
  }
  
  .poem-part {
    padding-left: 1rem;
    border-left: 2px solid #e5e7eb;
  }
</style>

<div class="poetry-page bg-gray-50 min-h-screen">
  <div class="max-w-4xl mx-auto px-4 py-12">
    <header class="text-center mb-12">
      <h1 class="text-4xl font-bold text-gray-800 mb-2">{t.title}</h1>
      <p class="text-lg text-gray-600">{t.subtitle}</p>
      <p class="mt-4 text-gray-600">{t.introduction}</p>
      <p class="text-sm text-gray-500 mt-2 italic">{t.footnoteHint}</p>
    </header>
    
    <div class="poem-tabs flex mb-8 border-b border-gray-200">
      <button 
        class="px-4 py-2 font-medium {selectedPoem === 'spiral' ? 'text-purple-600 border-b-2 border-purple-600' : 'text-gray-500 hover:text-gray-700'}"
        on:click={() => selectedPoem = 'spiral'}
      >
        {t.spiralExploration}
      </button>
      <button 
        class="px-4 py-2 font-medium {selectedPoem === 'alien' ? 'text-purple-600 border-b-2 border-purple-600' : 'text-gray-500 hover:text-gray-700'}"
        on:click={() => selectedPoem = 'alien'}
      >
        {t.alienWit}
      </button>
    </div>
    
    <div class="poem-content bg-white rounded-xl shadow-sm p-8">
      {#if selectedPoem === 'spiral'}
        <div class="spiral-poem">
          <h2 class="text-2xl font-bold text-center mb-2">{currentPoem.title}</h2>
          
          {#if currentPoem.introduction}
            <div class="poem-introduction text-gray-600 italic mb-8 text-center">
              {currentPoem.introduction}
            </div>
          {/if}
          
          <div class="poem-parts space-y-8">
            {#each currentPoem.parts as part}
              <div class="poem-part">
                <h3 class="text-xl font-semibold mb-4">{part.title}</h3>
                <div class="poem-text">
                  {#if part.footnotes}
                    {@html renderWithFootnotes(part.content, part.footnotes)}
                  {:else}
                    {part.content}
                  {/if}
                </div>
              </div>
            {/each}
          </div>
        </div>
      {:else}
        <div class="alien-poem">
          <h2 class="text-2xl font-bold text-center mb-2">{currentPoem.title}</h2>
          
          <div class="poem-introduction text-gray-600 italic mb-6 text-center">
            {currentPoem.introduction}
          </div>
          
          <div class="poem-text mb-8">
            {currentPoem.content}
          </div>
          
          {#if currentPoem.breakdown}
            <div class="poem-breakdown bg-gray-50 p-4 rounded-lg mb-6">
              <h3 class="font-semibold mb-2">{currentPoem.breakdown.title}</h3>
              <ul class="list-inside space-y-1">
                {#each currentPoem.breakdown.points as point}
                  <li class="text-gray-700">{@html point}</li>
                {/each}
              </ul>
            </div>
          {/if}
          
          {#if currentLanguage === 'sv' && currentPoem.extra}
            <div class="poem-extra bg-gray-50 p-4 rounded-lg">
              <h3 class="font-semibold mb-2">{currentPoem.extra.title}</h3>
              <ul class="list-inside space-y-1">
                {#each currentPoem.extra.points as point}
                  <li class="text-gray-700">{@html point}</li>
                {/each}
              </ul>
              {#if currentPoem.extra.closing}
                <p class="mt-4 text-gray-600 italic">{@html currentPoem.extra.closing}</p>
              {/if}
            </div>
          {/if}
        </div>
      {/if}
    </div>
    
    <div class="mt-8 text-center">
      <p class="text-gray-500 italic text-sm">
        {t.contribute}
      </p>
    </div>
  </div>
</div>
